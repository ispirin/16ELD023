// Josh Smith, Igor Spirin, Karl Stevenson - Oct. 2016 
// This code will display "Hello World!" on top and bottom line of your LCD

#include <at89c51cc03.h>

// Define RS pin that will be used to toggle P1_7 between command/data

#define RS 0x80

// Because delay functions are overrated. Real engineers code custom shit amirite?

void wait(unsigned int t)  {          /* wait function, 1ms delay made with trial and error */
   unsigned int c = 1, d = 1;
   for ( c = 1 ; c <= t ; c++ )
       for ( d = 1 ; d <= 124 ; d++ )
       {}                                 
}

// The board has two pins for disable/enable of LCD, the two functions below are for QoL

void enable_high(void)  {
	P3_4 = 1;
	P3_2 = 1;
}

void enable_low(void)  {
	P3_4 = 0;
	P3_2 = 0;
}

// To send stuff to the LCD: Disable LCD > Send first nibble > Enable LCD > Wait about 2 ms ? Disable LCD > Repeat for the second nibble

// Send command to the LCD i.e. disable blink, return cursor to start etc.

void lcd_cmd(char cmd)  { 
	enable_low();	
	P1 = ((cmd >> 4) & 0x0F);
	enable_high();
	wait(2);
	enable_low();	
	P1 = (cmd & 0x0F);
	enable_high();
	wait(2);
	enable_low();	
}

// Send the actual letters in HEX format

void lcd_com(unsigned char dat)  {
	enable_low();
	P1 = ((dat >> 4) & 0x0F)|RS;
	enable_high();
	wait(2);
	enable_low();
	P1 = (dat & 0x0F)|RS;
	enable_high();
	wait(2);
	enable_low();
}

// This uses above functions to initialise the LCD and send stock msg

void lcd_init(void) {
	lcd_cmd(0x28);       // 4-bit mode - 2 line - 5x7 font. 
	lcd_cmd(0x0C);       // Display no cursor - no blink.
	lcd_cmd(0x06);       // Automatic Increment - No Display shift.
}	

void clear_screen(void)  {
  lcd_cmd(0x01);
}

void line_one(void)  {
	lcd_cmd(0x80); 
}

void line_two(void)  {
	lcd_cmd(0xC0); 
}

void send_hello(void)  {
		lcd_com(0x54);
		lcd_com(0x65);
		lcd_com(0x65);
		lcd_com(0x6d);
		lcd_com(0x6f);
}

void send_world(void)  {
		lcd_com(0x47);
		lcd_com(0x65);
		lcd_com(0x74);
		lcd_com(0x20);
		lcd_com(0x72);
		lcd_com(0x65);
		lcd_com(0x6b);
		lcd_com(0x74);
}

void main()  {
	  line_one();
   	send_hello();
		line_two();
		send_world();
		wait(2000);
		clear_screen();
		line_one();
		send_world();
		line_two();
		send_hello();
		wait(2000);	
		clear_screen();
}
